# Cookie

인증에 필요한 기본지식 Cookie!

<br/>

### Cookie 배경

쇼핑몰 사이트에서 여러 페이지를 돌아다니면서 장바구니에 옷을 담았다

왜 장바구니가 유지 될까?

HTTP 는 무상태성(stateless)이라고 했는데 말이지

바로 쿠 키 덕 분

<br/>

### Cookie

간단하게

어떤 웹사이트에 들어갔을 때, 서버가 일방적으로 클라이언트에 전달하는 작은 데이터

보통은 의사를 묻지 않지만 물어보는 경우도 있다

자세하게

서버가 웹 브라우저에 정보를 저장하고 불러올 수 있는 수단

해당 도메인에 대해 쿠키가 존재하면, 웹 브라우저는 도메인에게 http 요청 시 쿠키를 함께 전달

<br/>

### Cookie 이용법

서버는 쿠키를 통해서 어떤 데이터를 저장하려고 하나요 ?

쿠키의 특성은 삭제를 하지 않으면 사라지지 않는 특성을 가지고 있다

장기간 저장해야 하는 옵션을 클라이언트에 저장하기에 적합하다

( 장바구니, 30일간 로그인 상태 유지 등 )

로그인, 로그아웃을 위해 인증 정보를 쿠키에 저장하는 경우도 많다

쿠키는 브라우저 설정 창에서 노출되어 보안상 위험하다 그래서 보통 해싱처리 되어 있다

근데 이마저도 불안하다 쿠키는 자바스크립트로 접근이 가능하기 때문이다

<br/>

### Cookie 전달 방법


쿠키가 클라이언트에 저장되고 자동적으로 요청되는 화면

서버

응답헤더에 쿠키 옵션(이름, 값, 경로 등)을 저장한다

클라이언트

쿠키가 담긴 응답을 받은 클라이언트는 쿠키를 확인한다

다음에 요청시마다 쿠키의 이름, 값 등을 서버에 전달

서버가 쿠키를 저장하면 이후 해당 웹사이트를 이용시 자동으로 요청과 함께 쿠키가 전송된다

<br/>

### Cookie Options

- Domain
    
    서버와 요청의 도메인이 일치하는 경우
    
- Path
    
    서버와 요청의 세부경로가 일치하는 경우
    
- MaxAge of Expires
    
    쿠키의 유효기간
    
    서버에서 쿠키에 이 옵션을 주면 일정 시간 후 자동 소멸이 된다 !
    
- HttpOnly
    
    스크립트의 쿠키 접근 가능 여부
    
    쿠키는 script 태그로 접근이 가능하여 XSS 공격에 취약하다
    
    민감한 정보가 개인 정보는 담지 않는 것이 좋다
    
- Secure
    
    HTTPS 프로토콜에서만 쿠키 전송 여부
    
- SameSite
    
    CORS 요청의 경우 옵션 및 메서드에 따라 쿠키 전송 여부
    
    CSRF 공격을 막을 수 있다 / 가짜 링크 보내는 것
    
    옵션
    
    - Lax
        
        GET 메서드 요청만 쿠키 전송 가능
        
    - Strict
        
        쿠키 전송 불가
        
    - None
        
        모든 메서드 요청에 대해 쿠키 전송 가능
        
        HTTPS 프로토콜 + Secure 쿠키 옵션 같이 사용
        
<br/>

### 쿠키

서버에서 클라이언트에 영속성있는 데이터를 저장하는 방법이다

서버가 원하면 클라이언트의 쿠키를 이용해서 데이터를 가져올 수 있다

쿠키를 이용한다는 건

단순히 서버에서 클라이언트에 쿠키를 전송하는 것만 의미하지 않고

클라이언트에서 서버로 쿠리를 다시 전송한다는 것도 포함이다

<br/>

### 쿠키의 특징

서버가 클라이언트에 특정한 데이터를 저장할 수 있다

데이터를 저장한 이후 아무때나 가져올 수는 없다 / 특정 조건이 만족되어야 한다

<br/>

### 쿠키옵션 더 자세히

- Domain
    
    도메인은 뭐였어요? 서버에 접속할 수 있는 다른 이름이었죠 (like 건물명)
    
    쿠키 도메인은 포트, 서브도메인, 세부경로를 제외한 것
    
    쿠키 도메인 === 서버 도메인 >>> 쿠키전송
    
    ```jsx
    // 요청 URL
    http://www.localhost.com:3000/users/login
    
    // 쿠키 도메인
    localhost.com
    ```
    
- Path ( 기본값 `/` )
    
    Path 는 뭐였어요? 세부 경로 / 서버가 라우팅할 때 사용하는 경로였습니다
    
    Path 는 하위 경로로 요청해도 쿠키 전송이 가능합니다
    
    명시하지 않으면 기본적으로 / 입니다
    
    ```jsx
    http://www.localhost.com:3000/users/login
    
    // Path
    /users/login
    
    // Path 특징
    // 하위 경로로 요청해도 쿠키 전송이 가능합니다
    /users
    /users/login 도 가능하다는 말
    ```
    
- MaxAge of Expires
    
    쿠키가 영원히 남아있다면 그만큼 탈취가 쉬우므로 유효기간을 설정하자
    
    - MaxAge
        
        초 단위 유효기간
        
    - Expires
        
        시간, 날짜 단위 유효기간
        
    
    유효기간 옵션에 따라 쿠키가 나뉜다
    
    - Session Cookie
        
        브라우저가 실행 중일때만 사용하는 임시 쿠키
        
    - Persistent Cookie
        
        유효기간 옵션이 설정된 쿠키
        
    
    ### `Max-age` vs `Expires`
    
    [HTTP Cookies: What's the difference between Max-age and Expires?](https://mrcoles.com/blog/cookies-max-age-vs-expires/)
    
    [Set-Cookie - HTTP | MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie)
    
- HttpOnly (기본값 `false`)
    - true
        
        자바스크립트로 쿠키 접근 불가능
        
    - false
        
        `document.cookie`를 통해서 접근 가능
        
    
- Secure
    - true
        
        HTTPS 를 이용하는 경우에만 쿠키 전송
        
    - 옵션 없음
        
        프로토콜 상관없이 쿠키 전송 가능
        
    
- SameSite
    
    Cross-Origin 요청을 받은 경우 요청에서 사용한 메소드와 해당 옵션(e.g. `GET`, `POST`, `PUT`, `PATCH` …)의 조합을 기준으로 서버의 쿠키 전송 여부를 결정하게 됩니다. 사용 가능한 옵션은 다음과 같습니다.
    
    - `Lax`: Cross-Origin 요청이라면 `GET` 메소드에 대해서만 쿠키를 전송할 수 있습니다.
    - `Strict`: 단어 그대로 가장 엄격한 옵션으로, Cross-Origin이 아닌 `same-site` 인 경우에만 쿠키를 전송 할 수 있습니다.
    - `None`: Cross-Origin에 대해 가장 관대한 옵션으로 항상 쿠키를 보내줄 수 있습니다. 다만 쿠키 옵션 중 `Secure` 옵션이 필요합니다.
    
    이때 `same-site`는 요청을 보낸 Origin과 서버의 도메인, 프로토콜, 포트가 같은 경우를 말합니다. 이 중 하나라도 다르다면 Cross-Origin으로 구분됩니다.
    
    서버에서 이러한 옵션들을 지정한 다음 서버에서 클라이언트로 쿠키를 처음 전송하게 된다면 헤더에 `Set-Cookie`라는 프로퍼티로 쿠키를 담아 전송합니다.
    
    이후 클라이언트에서 서버에게 쿠키를 전송해야 한다면 클라이언트는 헤더에 `Cookie`라는 프로퍼티에 쿠키를 담아 서버에 쿠키를 전송하게 됩니다.
    

<br/>

### 쿠키를 이용한 상태 유지

쿠키의 특성을 이용하여 

서버

클라이언트에 인증 정보를 담은 쿠키 전송

클라이언트

전달받은 쿠키를 서버에 요청과 같이 전송

무상태 인터넷연결을 상태인척 유지

하지만 쿠키는 보안이 취약하다

더 알아보기

[Set-Cookie - HTTP | MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie)
